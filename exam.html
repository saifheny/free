<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙØ­Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</title>
    <style>
        body { font-family: Tahoma, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        #startScreen, #resultScreen { text-align: center; }
        input[type="text"] { padding: 12px; width: 80%; margin: 20px 0; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; }
        
        /* Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† */
        #quizScreen { display: none; }
        .question-card { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .question-text { font-weight: bold; font-size: 18px; margin-bottom: 15px; color: #2c3e50; }
        .option-label { display: block; margin: 8px 0; cursor: pointer; padding: 8px; border-radius: 4px; transition: 0.2s; }
        .option-label:hover { background-color: #f9f9f9; }
        input[type="radio"] { margin-left: 10px; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { padding: 12px 30px; font-size: 18px; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn-start { background: #007bff; }
        .btn-submit { background: #28a745; width: 100%; margin-top: 20px; }

        /* Ø§Ù„Ù†ØªÙŠØ¬Ø© */
        #resultScreen { display: none; }
        .score-box { font-size: 24px; font-weight: bold; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .msg-good { color: #28a745; }
        .msg-bad { color: #dc3545; }
    </style>
</head>
<body>

<div class="container">
    <!-- 1. Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… -->
    <div id="startScreen">
        <h2 id="examTitleDisplay">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†...</h2>
        <p>ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¨Ø¯Ø¡</p>
        <input type="text" id="studentName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
        <br>
        <button class="btn btn-start" onclick="startExam()">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
    </div>

    <!-- 2. Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
    <div id="quizScreen">
        <div id="questionsList"></div>
        <button class="btn btn-submit" onclick="submitExam()">ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
    </div>

    <!-- 3. Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
    <div id="resultScreen">
        <h2>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h2>
        <p id="studentNameDisplay"></p>
        <div class="score-box" id="scoreDisplay"></div>
        <h3 id="feedbackMessage"></h3>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCsnZdFrg-KlWFc0z6OgmXgBp6lPKf14fU",
    authDomain: "saifsa-b51f1.firebaseapp.com",
    databaseURL: "https://saifsa-b51f1-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "saifsa-b51f1",
    storageBucket: "saifsa-b51f1.firebasestorage.app",
    messagingSenderId: "41089917871",
    appId: "1:41089917871:web:fce49f6f23bd4f679b055a",
    measurementId: "G-4K733KS3CP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let examData = null;
  const urlParams = new URLSearchParams(window.location.search);
  const examId = urlParams.get('id');

  // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  window.onload = async function() {
      if(!examId) {
          document.body.innerHTML = "<h3 style='text-align:center; margin-top:50px;'>Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ØºÙŠØ± ØµØ­ÙŠØ­</h3>";
          return;
      }

      const examRef = ref(db, 'exams/' + examId);
      try {
          const snapshot = await get(examRef);
          if(snapshot.exists()) {
              examData = snapshot.val();
              document.getElementById('examTitleDisplay').innerText = examData.title;
          } else {
              document.body.innerHTML = "<h3 style='text-align:center;'>Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</h3>";
          }
      } catch(e) {
          console.error(e);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
      }
  };

  window.startExam = function() {
      const name = document.getElementById('studentName').value;
      if(!name) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…"); return; }

      // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
      document.getElementById('startScreen').style.display = 'none';
      document.getElementById('quizScreen').style.display = 'block';

      const list = document.getElementById('questionsList');
      list.innerHTML = '';

      // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØªØ­Øª Ø¨Ø¹Ø¶
      examData.questions.forEach((q, index) => {
          let optionsHTML = '';
          q.options.forEach((opt, optIndex) => {
              optionsHTML += `
                <label class="option-label">
                    <input type="radio" name="q${index}" value="${optIndex}">
                    ${opt}
                </label>
              `;
          });

          const qHTML = `
            <div class="question-card">
                <div class="question-text">${index + 1}. ${q.text}</div>
                <div class="options-list">${optionsHTML}</div>
            </div>
          `;
          list.insertAdjacentHTML('beforeend', qHTML);
      });
  };

  window.submitExam = function() {
      if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©ØŸ")) return;

      let score = 0;
      const total = examData.questions.length;

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©
      examData.questions.forEach((q, index) => {
          const selected = document.querySelector(`input[name="q${index}"]:checked`);
          if(selected && parseInt(selected.value) === q.correctIndex) {
              score++;
          }
      });

      const percentage = (score / total) * 100;

      // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
      document.getElementById('quizScreen').style.display = 'none';
      document.getElementById('resultScreen').style.display = 'block';
      
      document.getElementById('studentNameDisplay').innerText = "Ø§Ù„Ø·Ø§Ù„Ø¨: " + document.getElementById('studentName').value;
      document.getElementById('scoreDisplay').innerText = `Ø§Ù„Ø¯Ø±Ø¬Ø©: ${score} Ù…Ù† ${total}`;

      const msgElement = document.getElementById('feedbackMessage');
      if(percentage >= 50) {
          msgElement.innerText = "Ù…Ù…ØªØ§Ø² ÙŠØ§ Ø¨Ø·Ù„! Ø£Ù†Øª Ø±Ø§Ø¦Ø¹ ğŸ”¥";
          msgElement.className = "msg-good";
      } else {
          msgElement.innerText = "Ø­Ø¸ Ø£ÙˆÙØ± Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©ØŒ Ø±ÙƒØ² Ø£ÙƒØ«Ø± ğŸ’ª";
          msgElement.className = "msg-bad";
      }
  };
</script>

</body>
</html>
