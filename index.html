<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>أصوات حرة - Voice of Freedom</title>
    
    <meta property="og:title" content="منبر الأحرار - تكلم بحرية">
    <meta property="og:description" content="مساحة صوتية حرة للنقاش والتعبير عن الرأي. انضم إلينا الآن.">
    <meta property="og:image" content="https://i.postimg.cc/g0KcyDsw/Elegant-White-Dove-With-Olive-Branch-White-Dove-Bird-Peace-PNG-Transparent-Image-and-Clipart-for.jpg">
    <meta property="og:type" content="website">

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;500;700;900&family=Outfit:wght@300;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root {
            --bg-deep: #050505;
            --bg-card: #0e0e0e;
            --white: #ffffff;
            --gold: #ffb700;
            --gold-glow: rgba(255, 183, 0, 0.3);
            --fabric-red: #c60000;
            --text-gray: #888888;
            --safe-bottom: 60px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }

        body {
            background-color: var(--bg-deep);
            color: var(--white);
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column; position: relative;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
        }

        .bg-effect {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 150vw; height: 150vw;
            background: radial-gradient(circle, rgba(255,255,255,0.03) 0%, rgba(0,0,0,0) 70%);
            pointer-events: none; z-index: 0;
        }

        .app-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; display: flex; flex-direction: column;
            opacity: 0; pointer-events: none; transition: 0.5s ease;
            transform: scale(0.95);
        }
        .app-view.active { opacity: 1; pointer-events: all; transform: scale(1); }

        .home-content { margin: auto; width: 100%; text-align: center; padding: 20px; z-index: 2; }
        .freedom-icon { font-size: 5rem; color: var(--white); margin-bottom: 10px; filter: drop-shadow(0 0 30px rgba(255,255,255,0.2)); }

        h1 { font-weight: 900; font-size: 2.2rem; margin-bottom: 0; color: #fff; }
        .slogan { font-size: 1.1rem; color: var(--gold); margin-bottom: 10px; font-weight: 700; letter-spacing: 1px; }
        .sub-text { color: var(--text-gray); font-size: 0.9rem; margin-bottom: 40px; }

        .main-btn {
            width: 100%; max-width: 320px; padding: 20px; margin: 15px auto;
            border-radius: 16px; border: 1px solid #222;
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; transition: 0.3s; background: rgba(255,255,255,0.03);
        }
        .main-btn .text-box { flex: 1; margin-right: 15px; text-align: right; }

        .room-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .live-badge { font-size: 0.9rem; font-weight: 700; color: #fff; }
        .copy-btn { background:transparent; border:1px solid #333; color:white; padding:8px 15px; border-radius:20px; cursor:pointer; }

        .grid-container { display: grid; gap: 15px; padding: 20px; overflow-y: auto; flex: 1; align-content: center; justify-content: center; margin-bottom: 120px; }
        .layout-1 { grid-template-columns: 1fr; max-width: 280px; margin: 0 auto; width: 100%; }
        .layout-2 { grid-template-columns: 1fr 1fr; max-width: 500px; margin: 0 auto; width: 100%; }
        .layout-more { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); width: 100%; }

        .user-card { aspect-ratio: 1; background: var(--bg-card); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border: 1px solid #222; overflow: hidden; }
        .card-avatar { width: 60px; height: 60px; border-radius: 50%; background: #000; border: 2px solid #333; color: var(--white); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 700; margin-bottom: 10px; z-index: 2; position: relative; }
        
        .voice-wave-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 20px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .voice-wave-container.speaking { opacity: 1; }
        
        .wave-bar {
            width: 4px;
            background-color: var(--gold);
            border-radius: 2px;
            animation: waveAnim 1s ease-in-out infinite;
        }
        .wave-bar:nth-child(1) { height: 40%; animation-delay: 0.0s; }
        .wave-bar:nth-child(2) { height: 70%; animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { height: 100%; animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { height: 60%; animation-delay: 0.3s; }

        @keyframes waveAnim {
            0%, 100% { height: 30%; }
            50% { height: 100%; }
        }

        .dock { position: absolute; bottom: var(--safe-bottom); left: 50%; transform: translateX(-50%); background: rgba(20,20,20,0.95); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 60px; border: 1px solid #222; display: flex; gap: 15px; z-index: 100; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .dock-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: var(--white); color: #000; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .dock-btn.danger { width: 60px; height: 60px; color: white; background-color: var(--fabric-red); border: 1px solid #8a0000; }

        .audio-gate { position: fixed; inset: 0; background: #000; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.4s; }
        .audio-gate.show { opacity: 1; pointer-events: all; }
        
        .share-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 300; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
        .share-overlay.show { opacity: 1; pointer-events: all; }
        .share-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: #151515; border-radius: 30px 30px 0 0; padding: 25px 20px; transition: 0.4s cubic-bezier(0.1, 0.7, 0.1, 1); z-index: 301; border-top: 1px solid #222; padding-bottom: calc(var(--safe-bottom) + 20px); }
        .share-sheet.show { bottom: 0; }
        .share-title { text-align: center; margin-bottom: 30px; font-weight: 700; font-size: 1.2rem; color: #fff; }
        .share-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .share-item { display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; }
        .share-icon { width: 55px; height: 55px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; color: white; }
        .share-label { font-size: 0.8rem; color: #888; }
        
        .whatsapp { background: #25D366; }
        .telegram { background: #0088cc; }
        .facebook { background: #1877F2; }
        .copy-link-item { background: #333; }

        .toast-container { position: fixed; bottom: calc(var(--safe-bottom) + 85px); left: 50%; transform: translateX(-50%); z-index: 400; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .toast { background: rgba(255,255,255,0.95); color: black; padding: 12px 25px; border-radius: 30px; font-size: 0.9rem; font-weight: 700; box-shadow: 0 10px 20px rgba(0,0,0,0.3); transform: translateY(20px); opacity: 0; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); margin-top: 10px; }
        .toast.show { transform: translateY(0); opacity: 1; }

        .filter-menu { position: absolute; bottom: calc(var(--safe-bottom) + 85px); left: 50%; transform: translateX(-50%); background: #fff; color: black; border-radius: 20px; padding: 10px; width: 180px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 110; border: 1px solid #ccc; }
        .filter-menu.show { opacity: 1; pointer-events: all; }
        .filter-opt { padding: 12px; border-radius: 12px; cursor: pointer; font-size: 0.9rem; font-weight: 700; text-align: center; }
        .filter-opt.selected { background: #000; color: white; }
    </style>
</head>
<body>

    <div class="bg-effect"></div>

    <div class="app-view active" id="v-home">
        <div class="home-content">
            <div class="freedom-icon"><i class="fas fa-dove"></i></div>
            <h1>منبر الأحرار</h1>
            <div class="slogan">تكلم بحرية</div>
            <p class="sub-text" id="id-text">جاري التحميل...</p>

            <div class="main-btn" id="btn-rejoin" onclick="rejoinLastRoom()">
                <div class="text-box">
                    <h3>غرفتك السابقة</h3>
                    <p id="last-room-txt">العودة للمساحة الأخيرة</p>
                </div>
                <div style="width:40px; height:40px; background:#222; border-radius:10px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-history"></i></div>
            </div>

            <div class="main-btn" onclick="createNewRoom()">
                <div class="text-box">
                    <h3>مساحة جديدة</h3>
                    <p>بدء نقاش جديد كلياً</p>
                </div>
                <div style="width:40px; height:40px; background:#222; border-radius:10px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-plus"></i></div>
            </div>
        </div>
    </div>

    <div class="app-view" id="v-room">
        <div class="room-header">
            <div class="live-badge"><i class="fas fa-circle" style="font-size: 8px; color: var(--gold); margin-left:5px;"></i> مباشر</div>
            <button class="copy-btn" onclick="openShareSheet()">دعوة الأصدقاء</button>
        </div>

        <div class="grid-container" id="grid"></div>

        <div class="filter-menu" id="filter-menu">
            <div class="filter-opt selected" onclick="applyFilter('none', this)">طبيعي</div>
            <div class="filter-opt" onclick="applyFilter('deep', this)">وقور</div>
            <div class="filter-opt" onclick="applyFilter('echo', this)">صدى</div>
        </div>

        <div class="dock">
            <button class="dock-btn active" id="mic-btn" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
            <button class="dock-btn danger" onclick="exitToMenu()"><i class="fas fa-times"></i></button>
            <button class="dock-btn" onclick="toggleFilters()"><i class="fas fa-sliders-h"></i></button>
        </div>
        
        <div id="audio-container"></div>
    </div>

    <div class="share-overlay" id="share-overlay" onclick="closeShareSheet()"></div>
    <div class="share-sheet" id="share-sheet">
        <div style="width: 40px; height: 5px; background: #333; border-radius: 10px; margin: 0 auto 30px;"></div>
        <h3 class="share-title">مشاركة المساحة</h3>
        <div class="share-grid">
            <div class="share-item" onclick="shareTo('whatsapp')">
                <div class="share-icon whatsapp"><i class="fab fa-whatsapp"></i></div>
                <span class="share-label">واتساب</span>
            </div>
            <div class="share-item" onclick="shareTo('telegram')">
                <div class="share-icon telegram"><i class="fab fa-telegram-plane"></i></div>
                <span class="share-label">تليجرام</span>
            </div>
            <div class="share-item" onclick="shareTo('facebook')">
                <div class="share-icon facebook"><i class="fab fa-facebook-f"></i></div>
                <span class="share-label">فيسبوك</span>
            </div>
            <div class="share-item" onclick="copyLinkAction()">
                <div class="share-icon copy-link-item"><i class="fas fa-link"></i></div>
                <span class="share-label">نسخ</span>
            </div>
        </div>
    </div>

    <div class="audio-gate" id="audio-gate">
        <div style="width: 80px; height: 80px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
            <i class="fas fa-microphone-alt" style="color: black; font-size: 2rem;"></i>
        </div>
        <h2 style="color: white; margin-bottom: 10px;">تفعيل الصوت</h2>
        <p style="color: #888; font-size: 0.9rem; margin-bottom: 30px;">يجب الضغط للسماح بسماع الآخرين</p>
        <button onclick="confirmEntry()" style="width: 200px; padding: 15px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer;">دخول الآن</button>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
            authDomain: "story-97cf7.firebaseapp.com",
            databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
            projectId: "story-97cf7",
            storageBucket: "story-97cf7.firebasestorage.app",
            messagingSenderId: "742801388214",
            appId: "1:742801388214:web:32a305a8057b0582c5ec17"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let user = JSON.parse(localStorage.getItem('vf_user')) || { id: 'u' + Math.random().toString(36).substr(2,9), code: Math.floor(100+Math.random()*900) };
        localStorage.setItem('vf_user', JSON.stringify(user));

        let localStream, peer, myPeerId, activeRoom;
        let audioCtx, audioSource, audioDestination, currentFilter;
        let isMuted = false;
        let calls = {};
        let roomRef = null;

        window.onload = () => {
            document.getElementById('id-text').innerHTML = `هويتك: <b>${user.code}</b>`;
            const urlRoom = new URLSearchParams(location.search).get('room');
            if(urlRoom) { activeRoom = urlRoom; document.getElementById('audio-gate').classList.add('show'); }
            updateUI();
        };

        function updateUI() {
            const last = localStorage.getItem('last_room');
            const btn = document.getElementById('btn-rejoin');
            if(last) { btn.style.opacity = '1'; document.getElementById('last-room-txt').innerText = "غرفة: " + last; btn.onclick = rejoinLastRoom; }
            else { btn.style.opacity = '0.5'; btn.onclick = null; }
        }

        window.showToast = (msg) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        };

        window.openShareSheet = () => { document.getElementById('share-overlay').classList.add('show'); document.getElementById('share-sheet').classList.add('show'); };
        window.closeShareSheet = () => { document.getElementById('share-overlay').classList.remove('show'); document.getElementById('share-sheet').classList.remove('show'); };

        window.copyLinkAction = () => {
            const link = `${location.origin}${location.pathname}?room=${activeRoom}`;
            navigator.clipboard.writeText(link).then(() => {
                showToast("تم نسخ الرابط");
                closeShareSheet();
            });
        };

        window.shareTo = (platform) => {
            const link = `${location.origin}${location.pathname}?room=${activeRoom}`;
            const text = `انضم إلي في منبر الأحرار: `;
            let url = '';
            if(platform === 'whatsapp') url = `https://wa.me/?text=${encodeURIComponent(text + link)}`;
            else if(platform === 'telegram') url = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`;
            else if(platform === 'facebook') url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`;
            window.open(url, '_blank');
            closeShareSheet();
        };

        window.createNewRoom = () => { activeRoom = Math.random().toString(36).substr(2,8); localStorage.setItem('last_room', activeRoom); document.getElementById('audio-gate').classList.add('show'); };
        window.rejoinLastRoom = () => { activeRoom = localStorage.getItem('last_room'); document.getElementById('audio-gate').classList.add('show'); };

        window.confirmEntry = async () => {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if(audioCtx.state === 'suspended') await audioCtx.resume();
                localStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true } });
                audioSource = audioCtx.createMediaStreamSource(localStream);
                audioDestination = audioCtx.createMediaStreamDestination();
                audioSource.connect(audioDestination);
                
                peer = new Peer(user.id);
                peer.on('open', id => { myPeerId = id; startRoom(); });
                peer.on('call', call => {
                    call.answer(audioDestination.stream);
                    call.on('stream', stream => handleRemoteStream(stream, call.peer));
                });
                peer.on('error', err => console.log(err));

                document.getElementById('audio-gate').classList.remove('show');
                document.getElementById('v-home').classList.remove('active');
                document.getElementById('v-room').classList.add('active');
            } catch(e) { showToast("يرجى السماح باستخدام الميكروفون"); }
        };

        function startRoom() {
            roomRef = ref(db, `rooms/${activeRoom}/users/${user.id}`);
            set(roomRef, { code: user.code, peerId: myPeerId });
            onDisconnect(roomRef).remove();

            onValue(ref(db, `rooms/${activeRoom}/users`), (snap) => {
                const users = snap.val() || {};
                renderUsers(users);
                Object.values(users).forEach(u => {
                    if(u.peerId !== myPeerId && !calls[u.peerId]) {
                        const call = peer.call(u.peerId, audioDestination.stream);
                        call.on('stream', stream => handleRemoteStream(stream, u.peerId));
                        calls[u.peerId] = call;
                    }
                });
            });
        }

        function handleRemoteStream(stream, peerId) {
            let audio = document.getElementById('audio-' + peerId);
            if(!audio) {
                audio = document.createElement('audio');
                audio.id = 'audio-' + peerId;
                audio.autoplay = true;
                audio.playsInline = true;
                document.getElementById('audio-container').appendChild(audio);
            }
            audio.srcObject = stream;
            
            const remoteCtx = new (window.AudioContext || window.webkitAudioContext)();
            const source = remoteCtx.createMediaStreamSource(stream);
            monitorVolume(source, peerId);
        }

        function monitorVolume(source, id) {
            const analyser = (source.context || audioCtx).createAnalyser();
            analyser.fftSize = 32;
            source.connect(analyser);
            const data = new Uint8Array(analyser.frequencyBinCount);
            
            const check = () => {
                if(!document.getElementById('v-room').classList.contains('active')) return;
                analyser.getByteFrequencyData(data);
                const vol = data.reduce((a,b) => a+b) / data.length;
                
                const waveContainer = document.getElementById('wave-' + id);
                if(waveContainer) {
                    if(vol > 15) {
                        waveContainer.classList.add('speaking');
                    } else {
                        waveContainer.classList.remove('speaking');
                    }
                }
                requestAnimationFrame(check);
            };
            check();
        }

        function renderUsers(users) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            const list = Object.values(users);
            grid.className = 'grid-container ' + (list.length <= 1 ? 'layout-1' : list.length === 2 ? 'layout-2' : 'layout-more');
            
            list.forEach(u => {
                const isMe = u.peerId === myPeerId;
                grid.innerHTML += `
                    <div class="user-card">
                        <div class="card-avatar">${u.code}</div>
                        
                        <div class="voice-wave-container" id="wave-${u.peerId}">
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                        </div>

                        <div style="font-size:0.75rem; color:#888; margin-top:5px;">${isMe ? 'أنت' : 'مشارك'}</div>
                    </div>
                `;
            });
            if(audioSource) monitorVolume(audioSource, myPeerId);
        }

        window.toggleMic = () => {
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            const btn = document.getElementById('mic-btn');
            btn.innerHTML = isMuted ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-microphone"></i>';
            btn.style.background = isMuted ? '#444' : '#fff';
            btn.style.color = isMuted ? '#fff' : '#000';
            showToast(isMuted ? "تم كتم الميكروفون" : "الميكروفون يعمل");
        };

        window.exitToMenu = () => {
            window.open('https://www.effectivegatecpm.com/k8fisnjjc?key=afa7ea920578f74cea5997d670bbe78e', '_blank');

            if (roomRef) {
                remove(roomRef);
                roomRef = null;
            }

            if(localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (peer) {
                peer.destroy();
                peer = null;
            }

            calls = {};
            myPeerId = null;
            activeRoom = null;
            isMuted = false;
            
            document.getElementById('audio-container').innerHTML = '';

            document.getElementById('v-room').classList.remove('active');
            document.getElementById('v-home').classList.add('active');
            
            const btn = document.getElementById('mic-btn');
            btn.innerHTML = '<i class="fas fa-microphone"></i>';
            btn.style.background = '#fff';
            btn.style.color = '#000';

            window.history.replaceState({}, document.title, window.location.pathname);
            updateUI();
        };

        window.toggleFilters = () => document.getElementById('filter-menu').classList.toggle('show');
        
        window.applyFilter = (type, el) => {
            document.querySelectorAll('.filter-opt').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('filter-menu').classList.remove('show');
            
            audioSource.disconnect();
            if(currentFilter) currentFilter.disconnect();
            
            if(type === 'none') {
                audioSource.connect(audioDestination);
            } else if(type === 'deep') {
                const f = audioCtx.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 500;
                audioSource.connect(f); f.connect(audioDestination); currentFilter = f;
            } else if(type === 'echo') {
                const delay = audioCtx.createDelay(); delay.delayTime.value = 0.3;
                const feedback = audioCtx.createGain(); feedback.gain.value = 0.3;
                delay.connect(feedback); feedback.connect(delay);
                
                audioSource.connect(audioDestination);
                audioSource.connect(delay); delay.connect(audioDestination);
                currentFilter = delay;
            }
            showToast("تم تحديث الفلتر");
        };
    </script>
</body>
</html>
