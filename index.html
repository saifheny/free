<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saif TV</title>
    <style>
        :root {
            --primary: #0f0f0f; --secondary: #1f1f1f;
            --text: #ffffff; --accent: #e50914; --gray: #b3b3b3;
        }
        body {
            font-family: 'Tajawal', sans-serif; margin: 0; color: var(--text);
            background-color: var(--primary); overflow-x: hidden;
        }
        /* Header */
        header { background: rgba(15,15,15,0.95); padding: 15px 5%; position: fixed; width: 90%; top: 0; z-index: 1000; backdrop-filter: blur(10px); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 2em; font-weight: 800; color: var(--accent); letter-spacing: 1px; }
        
        /* Sliders - ثابت ويتحرك بالسحب */
        .slider-container { width: 100%; overflow: hidden; position: relative; }
        .slider { 
            display: flex; gap: 15px; 
            overflow-x: scroll; 
            cursor: grab; 
            padding: 5px 0;
            scroll-snap-type: x mandatory; 
            -webkit-overflow-scrolling: touch; 
        }
        .slider::-webkit-scrollbar { display: none; }
        .slider { -ms-overflow-style: none; scrollbar-width: none; }

        /* Top Banner */
        .banner-section { margin-top: 80px; padding-bottom: 30px; } 
        
        /* تأثير الـ 3D والبروز */
        .banner-item { 
            min-width: 300px; height: 170px; border-radius: 10px; overflow: hidden; position: relative; 
            transition: 0.3s; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
        }
        .banner-item img { width: 100%; height: 100%; object-fit: cover; }
        .banner-item:hover { 
            transform: scale(1.05); z-index: 2; 
            box-shadow: 0 15px 30px rgba(0,0,0,0.7); 
        }
        
        /* Categories */
        .category-section { padding: 30px 5%; margin-bottom: 20px; } 
        .category-title { font-size: 1.5em; margin-bottom: 15px; border-right: 4px solid var(--accent); padding-right: 10px; }
        
        /* تأثير الـ 3D والبروز على بطاقات المسلسلات */
        .series-card { 
            min-width: 160px; border-radius: 8px; overflow: hidden; cursor: pointer; 
            transition: 0.3s; position: relative; background: var(--secondary); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
        }
        .series-card:hover { 
            transform: scale(1.05); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.6); 
        }
        .series-card img { width: 100%; height: 240px; object-fit: cover; }
        .series-card .title { padding: 10px; font-size: 0.9em; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Fullscreen Views */
        .fullscreen-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background: var(--primary); transform: translateY(100%); transition: transform 0.3s ease; overflow-y: auto; }
        .fullscreen-view.active { transform: translateY(0); }
        .view-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.3; background-size: cover; background-position: center; filter: blur(20px); z-index: -1; }
        .view-header { padding: 20px; display: flex; justify-content: flex-end; }
        .close-btn { background: rgba(255,255,255,0.1); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5em; cursor: pointer; }
        .view-content { padding: 20px; max-width: 1200px; margin: 0 auto; }

        /* Episode & Details Styling */
        .info-grid { display: flex; gap: 30px; margin-bottom: 40px; flex-wrap: wrap; }
        .poster-img { width: 220px; height: 330px; border-radius: 12px; object-fit: cover; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .text-content { flex: 1; }
        .action-btn { background: var(--accent); color: white; border: none; padding: 10px 25px; border-radius: 5px; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; margin-top: 5px; }
        .action-btn svg { width: 20px; height: 20px; fill: white; }
        
        .episode-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
        .episode-header h2 { margin: 0; font-size: 1.8em; }

        .episodes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .episode-card { background: rgba(255,255,255,0.05); padding: 10px; border: 2px solid transparent; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .episode-card:hover { background: rgba(255,255,255,0.1); }
        .episode-card.active { border-color: var(--accent); background: rgba(229, 9, 20, 0.2); }
        .episode-thumb { width: 100%; height: 110px; object-fit: cover; border-radius: 5px; margin-bottom: 8px; }

        .video-container { width: 100%; aspect-ratio: 16/9; background: black; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .video-container iframe { width: 100%; height: 100%; border: none; }

        /* Footer */
        footer { background-color: #050505; padding: 50px 5%; margin-top: 50px; border-top: 1px solid #333; }
        .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; }
        .footer-col h3 { color: var(--accent); margin-bottom: 20px; font-size: 1.2em; display: flex; align-items: center; gap: 10px; }
        .footer-links a { display: flex; align-items: center; gap: 10px; color: var(--gray); text-decoration: none; margin-bottom: 12px; transition: 0.3s; }
        .copyright { text-align: center; color: #555; margin-top: 40px; padding-top: 20px; border-top: 1px solid #222; font-size: 0.9em; }

        @media (max-width: 768px) {
            .episode-header { flex-direction: column; align-items: center; text-align: center; }
            .episode-header h2 { margin-bottom: 15px; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
</head>
<body>

    <header>
        <div class="logo">Saif TV</div>
    </header>

    <div class="banner-section slider-container" id="banner-container">
        <div class="slider" id="banner-content"></div>
    </div>

    <main id="main-content">
        <!-- الأقسام ستظهر هنا -->
    </main>

    <!-- Footer الاحترافي -->
    <footer>
        <div class="footer-grid">
            <!-- Footer Content... -->
        </div>
        <div class="copyright">© 2025 Saif TV - جميع الحقوق محفوظة</div>
    </footer>

    <!-- صفحة تفاصيل المسلسل -->
    <div class="fullscreen-view" id="details-view">
        <div class="view-bg" id="details-bg"></div>
        <div class="view-header">
            <button class="close-btn" onclick="closeView('details-view')">✕</button>
        </div>
        <div class="view-content" id="details-content"></div>
    </div>

    <!-- صفحة الحلقة (الواجهة الجديدة) -->
    <div class="fullscreen-view" id="episode-view">
        <div class="view-bg" id="episode-bg"></div>
        <div class="view-header">
            <button class="close-btn" onclick="closeView('episode-view')">✕</button>
        </div>
        <div class="view-content" id="episode-content"></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
      import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

      // هنا يتم وضع إعدادات Firebase الخاصة بك
      const firebaseConfig = { apiKey: "AIzaSyCsnZdFrg-KlWFc0z6OgmXgBp6lPKf14fU", authDomain: "saifsa-b51f1.firebaseapp.com", databaseURL: "https://saifsa-b51f1-default-rtdb.europe-west1.firebasedatabase.app", projectId: "saifsa-b51f1", storageBucket: "saifsa-b51f1.firebasestorage.app", messagingSenderId: "41089917871", appId: "1:41089917871:web:fce49f6f23bd4f679b055a" };
      const YOUTUBE_API_KEY = 'AIzaSyA4gfRf5sGQZ-a7ficcTcgU47aJV30cSgc'; // مفتاح API لـ YouTube
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      // جلب البيانات وبناء الواجهة الرئيسية
      onValue(ref(database, 'series/'), (snapshot) => {
          const data = snapshot.val() || {};
          const allPlaylists = [];
          Object.keys(data).forEach(cat => {
              Object.values(data[cat]).forEach(item => allPlaylists.push(item.playlistId));
          });
          const uniqueIds = [...new Set(allPlaylists)];
          buildBanner(uniqueIds);
          
          const mainContent = document.getElementById('main-content');
          mainContent.innerHTML = '';
          
          Object.keys(data).forEach(async cat => {
              const section = document.createElement('div');
              section.className = 'category-section';
              section.innerHTML = `<h2 class="category-title">${cat}</h2><div class="slider-container"><div class="slider" id="cat-${cat}"></div></div>`;
              mainContent.appendChild(section);
              
              const catIds = Object.values(data[cat]).map(i => i.playlistId);
              await buildSlider(document.getElementById(`cat-${cat}`), catIds);
              makeDraggable(document.getElementById(`cat-${cat}`)); 
          });
      });

      async function buildBanner(ids) {
          const container = document.getElementById('banner-content');
          container.innerHTML = '';
          const recentIds = ids.slice(-10); 
          
          for (const id of recentIds) {
              const info = await fetchYT(`playlists?part=snippet&id=${id}`);
              if(info && info.items.length > 0) {
                  const img = info.items[0].snippet.thumbnails.maxres?.url || info.items[0].snippet.thumbnails.high.url;
                  const div = document.createElement('div');
                  div.className = 'banner-item';
                  div.onclick = () => openSeries(id);
                  div.innerHTML = `<img src="${img}">`;
                  container.appendChild(div);
              }
          }
          if(container.children.length > 0) {
               makeDraggable(container);
          }
      }

      async function buildSlider(container, ids) {
          for (const id of ids) {
              const info = await fetchYT(`playlists?part=snippet&id=${id}`);
              if(info && info.items.length > 0) {
                  const title = info.items[0].snippet.title;
                  const img = info.items[0].snippet.thumbnails.high.url;
                  const div = document.createElement('div');
                  div.className = 'series-card';
                  div.onclick = () => openSeries(id);
                  div.innerHTML = `<img src="${img}"><div class="title">${title}</div>`;
                  container.appendChild(div);
              }
          }
      }

      async function openSeries(id) {
          const view = document.getElementById('details-view');
          const content = document.getElementById('details-content');
          content.innerHTML = '<h2 style="text-align:center">جاري التحميل...</h2>';
          view.classList.add('active');
          
          const info = await fetchYT(`playlists?part=snippet&id=${id}`);
          const items = await fetchYT(`playlistItems?part=snippet&playlistId=${id}&maxResults=50`);
          
          if(!info || !items || info.items.length === 0) {
             content.innerHTML = '<h2 style="text-align:center">عذراً، لم يتم العثور على بيانات المسلسل.</h2>';
             return;
          }
          
          const s = info.items[0].snippet;
          const bg = s.thumbnails.maxres?.url || s.thumbnails.high.url;
          document.getElementById('details-bg').style.backgroundImage = `url(${bg})`;
          
          // **********************************************
          // التعديل: إضافة دالة playEpisode() لفتح الحلقة عند الضغط
          // **********************************************
          const episodesHtml = items.items.map(e => `
              <div class="episode-card" onclick="playEpisode('${id}', '${e.snippet.resourceId.videoId}', '${e.snippet.title}')">
                  <img class="episode-thumb" src="${e.snippet.thumbnails.medium.url}">
                  <div>${e.snippet.title}</div>
              </div>
          `).join('');

          content.innerHTML = `
              <div class="info-grid">
                  <img class="poster-img" src="${s.thumbnails.high.url}">
                  <div class="text-content">
                      <h1>${s.title}</h1>
                      <p>${s.description.substring(0, 200)}${s.description.length > 200 ? '...' : ''}</p>
                      <button class="action-btn" onclick="shareLink('${id}')">
                          <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
                          مشاركة المسلسل
                      </button>
                  </div>
              </div>
              <h3>الحلقات (${items.items.length})</h3>
              <div class="episodes-grid">${episodesHtml}</div>
          `;
      }

      // تَم تعديل هذه الوظيفة لتلبية طلبك بالكامل
      async function playEpisode(playlistId, videoId, title) {
          const view = document.getElementById('episode-view');
          const content = document.getElementById('episode-content');
          document.getElementById('details-view').classList.remove('active');
          view.classList.add('active');
          
          content.innerHTML = `
              <!-- 1. المشغل في الأعلى -->
              <div class="video-container">
                  <iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" allow="autoplay; fullscreen" allowfullscreen></iframe>
              </div>
              
              <!-- 2. العنوان وزر المشاركة (صفحة حالية) -->
              <div class="episode-header">
                  <h2>${title}</h2> 
                  <button class="action-btn" onclick="shareLink('${playlistId}', '${videoId}')">
                    <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
                    مشاركة الحلقة الحالية
                  </button>
              </div>

              <!-- 3. باقي الحلقات -->
              <h3>باقي الحلقات</h3>
              <div class="episodes-grid" id="related-eps"></div>
          `;
          
          // تحميل الحلقات المقترحة في الاسفل
          const items = await fetchYT(`playlistItems?part=snippet&playlistId=${playlistId}&maxResults=50`);
          const html = items.items.map(e => {
             // تمييز الحلقة الحالية بخط أحمر
             const current = e.snippet.resourceId.videoId === videoId ? ' active' : '';
             return `
                 <div class="episode-card${current}" onclick="playEpisode('${playlistId}', '${e.snippet.resourceId.videoId}', '${e.snippet.title}')">
                      <img class="episode-thumb" src="${e.snippet.thumbnails.medium.url}">
                      <div>${e.snippet.title}</div>
                  </div>
              `;
          }).join('');
          document.getElementById('related-eps').innerHTML = html;
      }

      async function fetchYT(params) {
          try {
              const res = await fetch(`https://www.googleapis.com/youtube/v3/${params}&key=${YOUTUBE_API_KEY}`);
              return await res.json();
          } catch(e) { console.error("Error fetching YT data:", e); return null; }
      }

      window.closeView = (id) => {
          document.getElementById(id).classList.remove('active');
          if(id === 'episode-view') {
             const iframe = document.querySelector('#episode-content iframe');
             if(iframe) iframe.src = ''; // إيقاف الفيديو
          }
          if(window.location.hash.includes('#series=')) {
              window.history.pushState("", document.title, window.location.pathname + window.location.search);
          }
      };
      
      window.shareLink = (pid, vid) => {
          let url = `${window.location.origin}${window.location.pathname}#series=${pid}`;
          if(vid) url += `&vid=${vid}`;
          navigator.clipboard.writeText(url).then(() => alert('تم نسخ رابط الصفحة الحالية بنجاح!'));
      }
      
      // فتح الروابط المباشرة (Deep Linking)
      window.onload = () => {
          const hash = window.location.hash;
          if(hash.includes('series=')) {
              const pid = hash.split('series=')[1].split('&')[0];
              const vid = hash.includes('vid=') ? hash.split('vid=')[1].split('&')[0] : null;
              if(vid) {
                 playEpisode(pid, vid, 'جاري تحميل العنوان...');
              }
              else openSeries(pid);
          }
      }
      
      // كود تفعيل السحب اليدوي (Drag/Swipe)
      window.makeDraggable = (slider) => {
        let isDown = false;
        let startX;
        let scrollLeft;

        const startDrag = (e) => {
            isDown = true;
            slider.style.cursor = 'grabbing';
            const clientX = e.touches ? e.touches[0].pageX : e.pageX;
            startX = clientX - slider.offsetLeft;
            scrollLeft = slider.scrollLeft;
        };

        const endDrag = () => {
            isDown = false;
            slider.style.cursor = 'grab';
        };

        const moveDrag = (e) => {
            if(!isDown) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].pageX : e.pageX;
            const x = clientX - slider.offsetLeft;
            const walk = (x - startX) * 2; 
            slider.scrollLeft = scrollLeft - walk;
        };

        // أحداث الفأرة
        slider.addEventListener('mousedown', startDrag);
        slider.addEventListener('mouseleave', endDrag);
        slider.addEventListener('mouseup', endDrag);
        slider.addEventListener('mousemove', moveDrag);
        
        // أحداث اللمس (موبايل)
        slider.addEventListener('touchstart', startDrag, { passive: true });
        slider.addEventListener('touchend', endDrag);
        slider.addEventListener('touchmove', moveDrag, { passive: false });
      };
    </script>
</body>
</html>
